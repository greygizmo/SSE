---
title: GoSales Engine - Feature Engineering Flow
---

```mermaid
graph TB
    %% Start
    Start([Feature Engineering Start]) --> InitializeMonitor

    %% Initialization Phase
    subgraph "Initialization & Setup"
        InitializeMonitor[Initialize Pipeline Monitor<br/>pipeline_monitor.py]
        LoadConfiguration[Load Feature Configuration<br/>config.py]
        SetupDatabase[Setup Database Connections<br/>db.py]
        ValidateTypeSystem[Validate Type System<br/>types.py]
    end

    %% Data Loading Phase
    subgraph "Data Loading & Preparation"
        LoadTransactions[Load Transaction Data<br/>fact_transactions]
        LoadCustomers[Load Customer Data<br/>dim_customer]
        LoadProducts[Load Product Data<br/>dim_product]
        LoadRawSalesLog[Load Raw Sales Data<br/>fact_sales_log_raw]
        EnforceCustomerIdTypes[Enforce customer_id Types<br/>TypeEnforcer]
    end

    %% Customer Feature Engineering
    subgraph "Customer-Level Features"
        AggregateTransactionHistory[Aggregate Transaction History<br/>Sum, Count, Avg by Customer]
        CalculateRecency[Calculate Recency Metrics<br/>Days Since Last Purchase]
        ComputeMonetaryValue[Compute Monetary Value<br/>Total Spend, Avg Order Value]
        AnalyzePurchaseFrequency[Analyze Purchase Frequency<br/>Orders per Month]
        DeriveCustomerLifetime[Derive Customer Lifetime<br/>First Purchase to Now]
    end

    %% Product Feature Engineering
    subgraph "Product-Level Features"
        AnalyzeProductPopularity[Analyze Product Popularity<br/>Purchase Frequency by Product]
        CalculateProductMargins[Calculate Product Margins<br/>Profitability Metrics]
        TrackProductTrends[Track Product Trends<br/>Time-based Analysis]
        ComputeProductAffinity[Compute Product Affinity<br/>Cross-selling Opportunities]
    end

    %% Temporal Feature Engineering
    subgraph "Temporal Features"
        CreateTimeWindows[Create Time Windows<br/>Rolling Windows: 30/60/90/180/365 days]
        CalculateRollingMetrics[Calculate Rolling Metrics<br/>Moving Averages, Trends]
        GenerateSeasonalFeatures[Generate Seasonal Features<br/>Monthly/Quarterly Patterns]
        ComputeGrowthRates[Compute Growth Rates<br/>YoY, MoM Changes]
        BuildAdvancedTemporal[Build Advanced Temporal Features<br/>Advanced Analytics]
    end

    %% Collaborative Filtering Features
    subgraph "ALS Embedding Features"
        PrepareALSInput[Prepare ALS Input Data<br/>Customer-Product Matrix]
        ConfigureALSModel[Configure ALS Model<br/>Hyperparameters, Factors]
        TrainALSModel[Train ALS Model<br/>Matrix Factorization]
        ExtractCustomerEmbeddings[Extract Customer Embeddings<br/>Latent Factors]
        ExtractProductEmbeddings[Extract Product Embeddings<br/>Latent Factors]
        ComputeSimilarityScores[Compute Similarity Scores<br/>Cosine Similarity]
    end

    %% External Feature Integration
    subgraph "External Feature Integration"
        LoadIndustryData[Load Industry Classification Data<br/>External Data Sources]
        MapCustomerIndustries[Map Customer Industries<br/>Industry Classification]
        CalculateIndustryMetrics[Calculate Industry Metrics<br/>Industry Averages]
        IntegrateMarketData[Integrate Market Data<br/>Market Trends]
        ValidateIndustryMapping[Validate Industry Mapping<br/>Data Quality Checks]
    end

    %% Branch/Rep Feature Engineering
    subgraph "Branch & Rep Features"
        ExtractBranchInfo[Extract Branch Information<br/>From fact_sales_log_raw]
        ExtractRepInfo[Extract Rep Information<br/>From fact_sales_log_raw]
        AggregateBranchPerformance[Aggregate Branch Performance<br/>Sales by Branch]
        AnalyzeRepPerformance[Analyze Rep Performance<br/>Sales by Rep]
        CalculateBranchRepMetrics[Calculate Branch/Rep Metrics<br/>Performance Indicators]
    end

    %% Feature Validation & Quality
    subgraph "Feature Validation & Quality"
        ValidateFeatureConsistency[Validate Feature Consistency<br/>Type & Value Checks]
        CheckFeatureCompleteness[Check Feature Completeness<br/>Missing Value Analysis]
        DetectFeatureDrift[Detect Feature Drift<br/>Distribution Changes]
        ComputeFeatureImportance[Compute Feature Importance<br/>Preliminary Analysis]
        GenerateFeatureReports[Generate Feature Reports<br/>Quality Metrics]
    end

    %% Feature Storage & Caching
    subgraph "Feature Storage & Output"
        CacheFeatureMatrix[Cache Feature Matrix<br/>cache.py]
        SaveFeatureMetadata[Save Feature Metadata<br/>Feature Descriptions]
        ExportFeatureMatrix[Export Feature Matrix<br/>CSV/Parquet]
        UpdateFeatureRegistry[Update Feature Registry<br/>Feature Catalog]
        ValidateFeatureOutput[Validate Feature Output<br/>Final Quality Check]
    end

    %% End
    ValidateFeatureOutput --> Success([Feature Engineering Success])
    GenerateFeatureReports --> Failure([Feature Engineering Failed])

    %% Main Flow Connections
    Start --> InitializeMonitor
    InitializeMonitor --> LoadConfiguration
    LoadConfiguration --> SetupDatabase
    SetupDatabase --> ValidateTypeSystem
    ValidateTypeSystem --> LoadTransactions

    LoadTransactions --> LoadCustomers
    LoadTransactions --> LoadProducts
    LoadTransactions --> LoadRawSalesLog
    LoadCustomers --> EnforceCustomerIdTypes
    LoadProducts --> EnforceCustomerIdTypes
    LoadRawSalesLog --> EnforceCustomerIdTypes

    EnforceCustomerIdTypes --> AggregateTransactionHistory
    AggregateTransactionHistory --> CalculateRecency
    CalculateRecency --> ComputeMonetaryValue
    ComputeMonetaryValue --> AnalyzePurchaseFrequency
    AnalyzePurchaseFrequency --> DeriveCustomerLifetime

    DeriveCustomerLifetime --> AnalyzeProductPopularity
    AnalyzeProductPopularity --> CalculateProductMargins
    CalculateProductMargins --> TrackProductTrends
    TrackProductTrends --> ComputeProductAffinity

    ComputeProductAffinity --> CreateTimeWindows
    CreateTimeWindows --> CalculateRollingMetrics
    CalculateRollingMetrics --> GenerateSeasonalFeatures
    GenerateSeasonalFeatures --> ComputeGrowthRates
    ComputeGrowthRates --> BuildAdvancedTemporal

    BuildAdvancedTemporal --> PrepareALSInput
    PrepareALSInput --> ConfigureALSModel
    ConfigureALSModel --> TrainALSModel
    TrainALSModel --> ExtractCustomerEmbeddings
    ExtractCustomerEmbeddings --> ExtractProductEmbeddings
    ExtractProductEmbeddings --> ComputeSimilarityScores

    ComputeSimilarityScores --> LoadIndustryData
    LoadIndustryData --> MapCustomerIndustries
    MapCustomerIndustries --> CalculateIndustryMetrics
    CalculateIndustryMetrics --> IntegrateMarketData
    IntegrateMarketData --> ValidateIndustryMapping

    ValidateIndustryMapping --> ExtractBranchInfo
    ExtractBranchInfo --> ExtractRepInfo
    ExtractRepInfo --> AggregateBranchPerformance
    AggregateBranchPerformance --> AnalyzeRepPerformance
    AnalyzeRepPerformance --> CalculateBranchRepMetrics

    CalculateBranchRepMetrics --> ValidateFeatureConsistency
    ValidateFeatureConsistency --> CheckFeatureCompleteness
    CheckFeatureCompleteness --> DetectFeatureDrift
    DetectFeatureDrift --> ComputeFeatureImportance
    ComputeFeatureImportance --> GenerateFeatureReports

    GenerateFeatureReports --> CacheFeatureMatrix
    CacheFeatureMatrix --> SaveFeatureMetadata
    SaveFeatureMetadata --> ExportFeatureMatrix
    ExportFeatureMatrix --> UpdateFeatureRegistry
    UpdateFeatureRegistry --> ValidateFeatureOutput

    %% Parallel Monitoring
    InitializeMonitor --> ValidateFeatureConsistency
    LoadConfiguration --> ValidateFeatureConsistency
    EnforceCustomerIdTypes --> ValidateFeatureConsistency
    AggregateTransactionHistory --> ValidateFeatureConsistency
    TrainALSModel --> ValidateFeatureConsistency
    ValidateFeatureOutput --> ValidateFeatureConsistency

    %% Error Handling
    InitializeMonitor -->|Setup Failed| GenerateFeatureReports
    LoadConfiguration -->|Config Error| GenerateFeatureReports
    EnforceCustomerIdTypes -->|Type Error| GenerateFeatureReports
    TrainALSModel -->|ALS Failed| GenerateFeatureReports
    ValidateFeatureOutput -->|Validation Failed| GenerateFeatureReports

    %% Styling
    classDef setup fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef loading fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef customer fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef product fill:#e0f2f1,stroke:#00695c,stroke-width:2px
    classDef temporal fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef als fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef external fill:#f5f5f5,stroke:#424242,stroke-width:2px
    classDef branchrep fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef validation fill:#f9fbe7,stroke:#689f38,stroke-width:2px
    classDef storage fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef success fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px
    classDef failure fill:#ffcdd2,stroke:#c62828,stroke-width:3px

    class Start,InitializeMonitor,LoadConfiguration,SetupDatabase,ValidateTypeSystem setup
    class LoadTransactions,LoadCustomers,LoadProducts,LoadRawSalesLog,EnforceCustomerIdTypes loading
    class AggregateTransactionHistory,CalculateRecency,ComputeMonetaryValue,AnalyzePurchaseFrequency,DeriveCustomerLifetime customer
    class AnalyzeProductPopularity,CalculateProductMargins,TrackProductTrends,ComputeProductAffinity product
    class CreateTimeWindows,CalculateRollingMetrics,GenerateSeasonalFeatures,ComputeGrowthRates,BuildAdvancedTemporal temporal
    class PrepareALSInput,ConfigureALSModel,TrainALSModel,ExtractCustomerEmbeddings,ExtractProductEmbeddings,ComputeSimilarityScores als
    class LoadIndustryData,MapCustomerIndustries,CalculateIndustryMetrics,IntegrateMarketData,ValidateIndustryMapping external
    class ExtractBranchInfo,ExtractRepInfo,AggregateBranchPerformance,AnalyzeRepPerformance,CalculateBranchRepMetrics branchrep
    class ValidateFeatureConsistency,CheckFeatureCompleteness,DetectFeatureDrift,ComputeFeatureImportance,GenerateFeatureReports validation
    class CacheFeatureMatrix,SaveFeatureMetadata,ExportFeatureMatrix,UpdateFeatureRegistry,ValidateFeatureOutput storage
    class Success success
    class Failure failure
```

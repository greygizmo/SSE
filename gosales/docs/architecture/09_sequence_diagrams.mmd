%% GoSales Engine - Key Sequences (Pipeline, Monitoring, Customer Recommendations)

sequenceDiagram
    %% Participants
    participant User
    participant StreamlitApp
    participant PipelineOrchestrator
    participant ETLProcess
    participant FeatureEngine
    participant ModelTrainer
    participant Validator
    participant Monitor
    participant Dashboard
    participant DataCollector
    participant Database
    participant FileSystem
    participant Customer
    participant WebApp
    participant API
    participant ScoringEngine
    participant Model
    participant Scheduler
    participant Alerting

    rect rgb(232,245,233)
        Note over User,Monitor: Pipeline Execution Sequence
        User->>StreamlitApp: Start full pipeline run
        StreamlitApp->>PipelineOrchestrator: Initialize run context
        PipelineOrchestrator->>Monitor: Begin run monitoring
        PipelineOrchestrator->>ETLProcess: Execute ETL phase
        ETLProcess->>Monitor: Emit ETL metrics
        ETLProcess-->>PipelineOrchestrator: ETL complete
        PipelineOrchestrator->>FeatureEngine: Build feature matrix
        FeatureEngine->>FeatureEngine: Enrich customers/products
        FeatureEngine->>Monitor: Capture feature metrics
        FeatureEngine-->>PipelineOrchestrator: Feature build complete
        PipelineOrchestrator->>ModelTrainer: Train or load models
        ModelTrainer->>Monitor: Record training diagnostics
        ModelTrainer-->>PipelineOrchestrator: Models ready
        PipelineOrchestrator->>Validator: Run gauntlet + CI gates
        Validator->>Monitor: Publish validation metrics
        Validator-->>PipelineOrchestrator: Validation pass/fail
        PipelineOrchestrator->>Monitor: Finalize run summary
        Monitor-->>StreamlitApp: Run status + metrics
        StreamlitApp-->>User: Show pipeline results
    end

    rect rgb(248,249,215)
        Note over Validator,Monitor: Leakage Gauntlet (Dynamic) per Division
        User->>Validator: Run Leakage Gauntlet (batch)
        Validator->>FeatureEngine: Build features @ cutoff and cutoff-14d
        FeatureEngine-->>Validator: Feature matrices
        Validator->>ModelTrainer: Fit LR (time-aware split)
        ModelTrainer-->>Validator: AUC/Lift@10 metrics
        Validator->>Validator: SAFE-mask evaluation (drop high-risk families)
        Validator->>Monitor: Record PASS/FAIL gates
        Validator-->>User: Per-division reports + cross-division summary
    end

    rect rgb(227,242,253)
        Note over User,Dashboard: Monitoring Dashboard Sequence
        User->>Dashboard: Open monitoring tab
        Dashboard->>DataCollector: Request health snapshot
        DataCollector->>Database: Query pipeline metrics
        Database-->>DataCollector: Return metrics
        DataCollector->>FileSystem: Read log excerpts
        FileSystem-->>DataCollector: Provide log data
        DataCollector->>Monitor: Fetch real-time status
        Monitor-->>DataCollector: Health signals
        DataCollector->>Dashboard: Aggregated monitoring payload
        Dashboard->>Dashboard: Render health, quality, performance
        User->>Dashboard: Export monitoring report
        Dashboard->>FileSystem: Persist report artifact
        FileSystem-->>User: Download link available
    end

    rect rgb(255,243,224)
        Note over Customer,Model: Customer Recommendation Sequence
        Customer->>WebApp: Request recommendations
        WebApp->>API: Fetch curated features
        API->>Database: Load customer profile
        Database-->>API: Profile payload
        API->>ScoringEngine: Score division models
        ScoringEngine->>Model: Load latest models
        Model-->>ScoringEngine: Scores + top-K yields
        ScoringEngine-->>API: Ranked opportunities
        API->>WebApp: Return recommendations
        WebApp-->>Customer: Display personalized list
        Scheduler->>Alerting: Queue follow-up notifications
        Alerting-->>Customer: Send recommended action
    end

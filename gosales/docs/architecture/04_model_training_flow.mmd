flowchart TD
  A[Start: CLI args] --> B[Load config.yaml]
  A -->|--segment warm|cold|both| C[Override population.build_segments]
  B --> D[Select DB connection]
  C --> D
  D --> E[Create feature matrix]
  E -->|build_segments: warm|cold| F[Early roster gating\n(warm by tx window; cold by assets_ever_total)]
  F --> G[Segment feature allowlist\n(per-segment pruning)]
  G --> H[Train per-cutoff models\n(LR, LGBM)]
  H --> I[Evaluate & aggregate\n(lift@K, Brier, AUC)]
  I --> J[Select winner]
  J --> K[Final fit on last cutoff]
  K --> L{Calibrate\n(platt|isotonic)}
  L -->|degenerate std(p)<0.01| M[Fallback to uncalibrated]
  M -->|still degenerate| N[Fallback to constant prevalence]
  L -->|ok| O[Use calibrated]
  M --> O
  N --> O
  O --> P[Emit artifacts\n(metrics, gains, thresholds, card)]
  P --> Q[Diagnostics\n(population_gating_*.csv, roster_diagnostics_*.csv)]


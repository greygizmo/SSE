%% GoSales Engine - Feature Families (Cycle-aware, Offsets, Encoders, Affinity)

graph TB
    %% Start
    Start(("Feature Families Overview"))

    %% Temporal & Cycle-aware
    subgraph "Temporal & Cycle-aware"
        Temporal["Create Time Windows<br/>3m | 6m | 12m | 24m"]
        LogRecency["Log Recency<br/>log(1 + days)"]
        Hazard["Hazard/Decay Recency<br/>exp(-days / half-life)"]
        Offsets["Offset Windows<br/>cutoff minus offset days"]
        Deltas["Window Deltas<br/>12m vs prior 12m"]
        Tenure["Tenure Buckets<br/><3m | 3-6m | 6-12m | 1-2y | >=2y"]
    end

    %% External Encoders & Diversity
    subgraph "External & Encoders"
        IndMap["Industry/Sub Mapping<br/>dim_customer"]
        PooledEnc["Hierarchical/Pooled Encoders<br/>industry + subindustry"]
        Diversity["Uniqueness & Diversity<br/>SKU and division counts"]
        Dynamics["Monthly Dynamics (12m)<br/>slope and std of GP/TX"]
    end

    %% Affinity & ALS
    subgraph "Affinity & Embeddings"
        AffinityLag["Lagged Market Basket<br/>embargo >= affinity_lag_days<br/>mb_lift and affinity sums"]
        ALS["ALS Embeddings (optional)<br/>als_f* latent factors"]
        Assets["Asset Rollups at Cutoff<br/>expiring 30/60/90d, subs share"]
    end

    %% Outputs
    subgraph "Outputs"
        FeatureMatrix["Feature Matrix<br/>features X with target y"]
        Catalog["Feature Catalog<br/>coverage and descriptions"]
    end

    %% Flow
    Start --> Temporal
    Temporal --> LogRecency
    LogRecency --> Hazard
    Hazard --> Offsets
    Offsets --> Deltas
    Temporal --> Tenure

    Start --> IndMap
    IndMap --> PooledEnc
    PooledEnc --> Diversity
    Diversity --> Dynamics

    Start --> AffinityLag
    AffinityLag --> ALS
    ALS --> Assets

    %% Consolidation
    Tenure --> FeatureMatrix
    Dynamics --> FeatureMatrix
    Assets --> FeatureMatrix
    FeatureMatrix --> Catalog

    %% Styling
    classDef temporal fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef encoders fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef affinity fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef outputs fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef start fill:#c8e6c9,stroke:#2e7d32,stroke-width:3px

    class Start start
    class Temporal,LogRecency,Hazard,Offsets,Deltas,Tenure temporal
    class IndMap,PooledEnc,Diversity,Dynamics encoders
    class AffinityLag,ALS,Assets affinity
    class FeatureMatrix,Catalog outputs
